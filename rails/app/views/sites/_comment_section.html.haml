%div{ id: "site_comments_#{site.id}" }
  %details.site-comments{ style: 'font-size: 60%; margin-top: 0rem;' }
    %summary.text-muted{ style: "cursor: pointer;" }
      %strong
        #{site.comments.count}
        = site.comments.count == 1 ? t('comments.title_singular') : t('comments.title_plural')
      #{bi_icon('feather', height: '1.2em', fill: '#777')}

    - if user_signed_in?
      - comment_record = site.comments.find_by(user: current_user) || Comment.new

      = form_with model: comment_record,
                  url: site_comments_path(site),
                  method: :post,
                  data: { turbo: true } do |f|

        .mb-2.position-relative
          = f.text_area :body,
                        value: comment_record.body || '',
                        rows: 4,
                        class: 'form-control form-control-sm comment-body-input',
                        style: 'margin-top: 0rem; font-size: 90%; resize: vertical;',
                        placeholder: t('comments.your_comment_short'),
                        required: true,
                        maxlength: 1500,
                        'aria-describedby': 'comment-help comment-progress'

          .progress.mt-1{ style: 'height: 6px;' }
            .progress-bar#comment-progress-bar{ 
              role: 'progressbar', 
              style: 'width: 0%;', 
              aria: { valuenow: '0', valuemin: '0', valuemax: '100' } 
            }

          .d-flex.justify-content-between.mt-1
            %small.text-muted#comment-help
              = t('comments.comment_required_characters') || "Mindestens ein Zeichen erforderlich"
            %small.text-muted#current-count 0 / 1500

        .mb-1
          = f.submit t(comment_record.persisted? ? 'comments.update_button' : 'comments.create_button'),
                     class: 'btn btn-sm btn-outline-primary comment-submit-btn',
                     style: 'margin-top: 0rem; font-size: 100%;'

    - else
      .text-muted{ style: 'margin-bottom: 0.0rem; margin-top: 0.0rem;' }
        = t('comments.login_hint_short')

    - site.comments.includes(:user).order(created_at: :desc).limit(3).each do |comment|
      .comment-item{ style: 'border-top: 1px solid #eee; padding-top: 0.2rem; margin-top: 0.2rem; font-size: 90%; position: relative;' }
        %span.text-muted
          = comment.user.username.presence || comment.user.email
          = ' · '
          = l(comment.created_at, format: :long)
          - if comment.edited_at.present?
            %br
            = "(#{t('comments.edited')}: #{l(comment.edited_at, format: :long)})"

        %div
          - truncated = comment.body.truncate(150, separator: ' ', omission: '…')
          = simple_format(truncated, {}, wrapper_tag: 'span')
          - if comment.body.length > 150
            %small.text-muted= " (#{comment.body.length} Zeichen)"

        %span.text-muted.d-flex.justify-content-between.align-items-center.mt-1
          / Score kommt später
        - if user_signed_in? && comment.user == current_user
          = link_to t('comments.delete_button'),
                    site_comment_path(site, comment),
                    method: :delete,
                    data: { confirm: t('comments.delete_confirm') },
                    class: 'btn btn-sm btn-link text-danger p-0',
                    style: 'font-size: 90%; text-decoration: none;'

    - if site.comments.count > 1
      .text-center.mt-2
        = turbo_off_link_to t('comments.show_all_button', count: site.comments.count),
                  site_comments_path(site),
                  class: 'btn btn-sm btn-outline-primary mt-2 d-block text-center',
                  style: 'font-size: 100%;'